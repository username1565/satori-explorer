/*!
 * Cirquity - Cirquity v0.1.0 (https://cirquity.com)
 * Copyright 2020-2020 The Cirquity Developers
 * Licensed under MIT (https://github.com/cirquity/cirquity-website/blob/master/LICENSE)
 */

!function(t){let e,a,i,o=[],s=[],n=[],r=[],l=[];t((function(){currentPage="home";let a=setInterval((function(){appReady&&(t.when(t.renderInitialBlocks()).then((function(){setTimeout((function(){t.displayDiffChart(),t.refreshChart()}),500)})).done(t.updateHome()),clearInterval(a))}),10);t("#loadMoreBlocks").click((function(){e&&e.abort(),e=t.ajax({url:api+"/json_rpc",method:"POST",data:JSON.stringify({jsonrpc:"2.0",id:"loadMore",method:"f_blocks_list_json",params:{height:t("#blocks-rows").children().last().data("height")}}),dataType:"json",cache:"false",success:function(e){t.when(t.renderBlocks(e.result.blocks)).then((function(){setTimeout((function(){t.loadMoreChart()}),100)}))}})}))})),t.updateHome=function(){t.renderLastBlock(),t.updateText("networkHeight",t.localizeNumber(lastStats.height.toString()));let e=new Date((new Date).getFullYear(),(new Date).getMonth(),(new Date).getDate(),(new Date).getHours(),(new Date).getMinutes()+2*(205e3-lastStats.height));t.updateText("nextFork",lastStats.last_known_block_index<205001?t.renderDate(e):"to be announced..."),t.updateText("networkTransactions",t.localizeNumber(lastStats.tx_count.toString())),t.updateText("networkHashrate",t.getReadableHashRateString(lastStats.difficulty/blockTargetInterval)),t.updateText("networkDifficulty",t.getReadableDifficultyString(lastStats.difficulty,0).toString()),t.getPoolTransactions();let a=t("#blocks-rows").children().first().data("height");a+31>lastStats.last_known_block_index&&t.when(t.renderInitialBlocks()).then((function(){setTimeout((function(){t.refreshChart()}),100)})),a+31<lastStats.last_known_block_index&&t("#next-page").removeClass("disabled")},t.renderInitialBlocks=function(){let a;e&&e.abort(),a=t.urlParam("height")?parseInt(t.urlParam("height")):lastStats.last_known_block_index+1,a-31<0&&(t("#prev-page").addClass("disabled"),t("#next-page").removeClass("disabled")),e=t.ajax({url:api+"/json_rpc",method:"POST",data:JSON.stringify({jsonrpc:"2.0",id:"test",method:"f_blocks_list_json",params:{height:a}}),dataType:"json",cache:"false",success:function(e){t.renderBlocks(e.result.blocks)}})},t.renderLastBlock=function(){t.ajax({url:api+"/json_rpc",method:"POST",data:JSON.stringify({jsonrpc:"2.0",id:"lastBlock",method:"getlastblockheader",params:{}}),dataType:"json",cache:"false",success:function(e){const i=e.result.block_header.hash;t.ajax({url:api+"/json_rpc",method:"POST",data:JSON.stringify({jsonrpc:"2.0",id:"lastBlockHash",method:"f_block_json",params:{hash:i}}),dataType:"json",cache:"false",success:function(e){a=e.result.block,t.updateText("totalCoins",t.getReadableCoins(a.alreadyGeneratedCoins,2)),t.updateText("emissionPercent",(a.alreadyGeneratedCoins/coinTotalSupply*100).toFixed(4)),t.updateText("currentReward",t.getReadableCoins(a.baseReward,2))}})}})},t.renderBlocks=function(e){let a=t("#blocks-rows");for(let i=0;i<e.length;i++){let o=e[i],s=JSON.stringify(o),n=document.getElementById("blockRow"+o.height);if(n&&n.getAttribute("data-json")!==s)t(n).replaceWith(t.getBlockRowElement(o,s));else if(!n){let e=t.getBlockRowElement(o,s),i=!1,n=a.children().get();for(let a=0;a<n.length;a++){if(parseInt(n[a].getAttribute("data-height"))<o.height){i=!0,t(n[a]).before(e);break}}i||a.append(e)}}t.renderBlocksPageRange(e),t.calcAvgHashRate()},t.getBlockRowElement=function(e,a){let i=document.createElement("tr");i.setAttribute("data-json",a),i.setAttribute("data-height",e.height),i.setAttribute("id","blockRow"+e.height),i.setAttribute("title",e.hash);let d=new Date(1e3*e.timestamp).toISOString();i.setAttribute("data-dt",d);let c='<th scope="row" class="height">'+t.localizeNumber(e.height)+'</th><td class="size">'+t.localizeNumber(e.cumul_size)+'</td><th scope="row">'+t.formatBlockLink(e.hash)+'</th><td class="blk-diff">'+t.localizeNumber(e.difficulty)+'</td><td class="txses">'+t.localizeNumber(e.tx_count)+'</td><td class="date-time">'+t.formatDate(e.timestamp)+"</td>";return o.push(parseInt(e.difficulty)),s.push(parseInt(e.height)),n.push(parseInt(e.tx_count)),r.push(parseInt(e.cumul_size)),l.push(d),i.innerHTML=c,i},t.getPoolTransactions=function(){t.ajax({url:api+"/json_rpc",method:"POST",data:JSON.stringify({jsonrpc:"2.0",id:"poolTransactions",method:"f_on_transactions_pool_json",params:{}}),dataType:"text",cache:"false",success:function(e){let a=document.getElementById("mem-pool-rows");for(;a.firstChild;)a.removeChild(a.firstChild);let i=e.split('"transactions":').pop();i=i.split("}}")[0];let o=JSON.parse(i),s=[];s=i.split("\n\n");for(let e in o){let i=o[e].hash;if(""!==i){let s=o[e].amount_out.toFixed(2),n=o[e].fee.toFixed(2),r=o[e].size,l=document.createElement("tr"),d=(Date().now,'<th scope="row">'+t.getReadableCoins(s,2,!0)+"</th><td>"+t.getReadableCoins(n,2,!0)+"</td><td>"+t.localizeNumber(r)+'</td><th scope="row">'+t.formatPaymentLink(i)+"</th>");l.innerHTML=d,t(a).append(l)}}t.updateText("mempool_count",document.querySelectorAll("#mem-pool-rows tr").length)},error:function(t){console.log(t)}})},t.renderBlocksPageRange=function(e){let a=[t.localizeNumber(e[0].height),t.localizeNumber(e[e.length-1].height)].join(" - ");t.updateText("block-range",a)},t.calcAvgHashRate=function(){let e=o.reduce((function(t,e){return t+e}),0),a=Math.round(e/o.length);blockTargetInterval;t.updateText("avgDifficulty",t.getReadableDifficultyString(a,0).toString()),t.updateText("avgHashrate",t.getReadableHashRateString(a/blockTargetInterval))},t.displayDiffChart=function(){let e=document.getElementById("difficultyChart"),a={labels:[].concat(t.formatDate(l)).reverse(),datasets:[{data:[].concat(s).reverse(),yAxisID:"Height",label:"Height",backgroundColor:"rgba(0,0,0,0)",borderColor:"rgba(0,0,0,0)",borderWidth:0,pointBorderWidth:0,pointRadius:0,pointHoverRadius:0,pointHitRadius:0,display:!1},{data:[].concat(o).reverse(),yAxisID:"Difficulty",label:"Difficulty",backgroundColor:"rgba(250,215,118,0.3)",borderColor:"#fad776",borderWidth:1,pointColor:"#fad776",pointBorderColor:"#fad776",pointHighlightFill:"#fad776",pointBackgroundColor:"#fad776",pointBorderWidth:1,pointRadius:1,pointHoverRadius:3,pointHitRadius:20},{data:[].concat(n).reverse(),yAxisID:"Transactions",label:"Transactions",backgroundColor:"rgba(66,186,150,0.4)",borderColor:"#42ba96",borderWidth:1,pointColor:"#42ba96",pointBorderColor:"#42ba96",pointHighlightFill:"#42ba96",pointBackgroundColor:"#42ba96",pointBorderWidth:1,pointRadius:1,pointHoverRadius:3,pointHitRadius:20},{data:[].concat(r).reverse(),yAxisID:"Sizes",label:"Size",backgroundColor:"rgba(124,105,239,0.4)",borderColor:"#7c69ef",borderWidth:1,pointColor:"#7c69ef",pointBorderColor:"#7c69ef",pointHighlightFill:"#7c69ef",pointBackgroundColor:"#7c69ef",pointBorderWidth:1,pointRadius:1,pointHoverRadius:3,pointHitRadius:20}]};i=new Chart(e,{type:"line",data:a,options:{responsive:!0,maintainAspectRatio:!1,title:{display:!1},legend:{display:!1},scales:{yAxes:[{id:"Height",type:"linear",position:"left",scaleLabel:{display:!1,labelString:"Height"},gridLines:{display:!1},ticks:{fontSize:9,display:!1},display:!1},{id:"Difficulty",position:"left",scaleLabel:{display:!1,labelString:"Difficulty"},gridLines:{display:!1},ticks:{fontSize:9,display:!1},display:!1},{id:"Transactions",type:"linear",position:"right",scaleLabel:{display:!1,labelString:"Transactions"},gridLines:{display:!1},ticks:{fontSize:9,display:!1},display:!1},{id:"Sizes",type:"linear",position:"right",scaleLabel:{display:!1,labelString:"Size"},gridLines:{display:!1},ticks:{fontSize:9,display:!1},display:!1}],xAxes:[{type:"time",time:{parser:!1,unit:"minute",unitStepSize:60,round:"second",displayFormats:{millisecond:"SSS [ms]",second:"HH:mm:ss",minute:"HH:mm",hour:"HH:mm",day:"MMM Do",week:"ll",month:"MMM YYYY",quarter:"[Q]Q - YYYY",year:"YYYY"}},gridLines:{display:!1},ticks:{fontSize:9,fontColor:"#CCC",autoSkip:!0}}]},tooltips:{mode:"index",callbacks:{title:function(t,e){e.datasets[3].data[t[0].index];return new Date(e.labels[t[0].index]).toLocaleString()+""}}}}})},t.refreshChart=function(){let e=t("#blocks-rows").children(),a=[],o=[],s=[],n=[],r=[];for(let i=0;i<e.length;i++){let l=t(e[i]),d=parseInt(l.find("th.height").text().replace(/[, ]+/g,"").trim()),c=parseInt(l.find("td.blk-diff").text().replace(/[, ]+/g,"").trim()),p=parseInt(l.find("td.txses").text().replace(/[, ]+/g,"").trim()),u=parseInt(l.find("td.size").text().replace(/[, ]+/g,"").trim()),h=l.attr("data-dt");a.push(d),o.push(c),r.push(p),s.push(u),n.push(h)}i&&(i.data.labels=n.reverse(),i.data.datasets[0].data=a.reverse(),i.data.datasets[1].data=o.reverse(),i.data.datasets[2].data=r.reverse(),i.data.datasets[3].data=s.reverse(),i.update())},t.loadMoreChart=function(){i.data.labels=[].concat(l).reverse(),i.data.datasets[0].data=[].concat(s).reverse(),i.data.datasets[1].data=[].concat(o).reverse(),i.data.datasets[2].data=[].concat(n).reverse(),i.data.datasets[3].data=[].concat(r).reverse(),i.update()}}(jQuery);